<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24HD ë¡œê·¸ì¸ ì‹œìŠ¤í…œ</title>

    <!-- Firebase SDK í™œì„±í™” -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", sans-serif;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #ffffff;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 40px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        font-family: "Orbitron", sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(45deg, #c19b3a 0%, #d4af37 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 5px;
      }

      .logo p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #c19b3a;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .form-input {
        width: 100%;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #ffffff;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #c19b3a;
        box-shadow: 0 0 20px rgba(193, 155, 58, 0.3);
        background: rgba(255, 255, 255, 0.15);
      }

      .form-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .login-btn,
      .social-btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .login-btn {
        background: linear-gradient(45deg, #c19b3a 0%, #d4af37 100%);
        color: #000000;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(193, 155, 58, 0.4);
      }

      .social-btn {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-transform: none;
        font-weight: 500;
      }

      .social-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .google-btn {
        background: #4285f4;
        border-color: #4285f4;
      }

      .google-btn:hover {
        background: #357ae8;
      }

      .phone-btn {
        background: #00c851;
        border-color: #00c851;
      }

      .phone-btn:hover {
        background: #00a63f;
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 25px 0;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9rem;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: rgba(255, 255, 255, 0.2);
      }

      .divider span {
        padding: 0 15px;
      }

      .login-btn:disabled,
      .social-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .register-link {
        text-align: center;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .register-link a {
        color: #c19b3a;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .register-link a:hover {
        color: #d4af37;
      }

      .error-message {
        background: rgba(255, 71, 87, 0.2);
        color: #ff4757;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 71, 87, 0.3);
        font-size: 0.9rem;
        text-align: center;
      }

      .success-message {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(0, 255, 136, 0.3);
        font-size: 0.9rem;
        text-align: center;
      }

      .loading {
        display: none;
        text-align: center;
        color: #c19b3a;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 1000;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 40px;
        width: 90%;
        max-width: 400px;
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.5rem;
        cursor: pointer;
      }

      #recaptcha-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
      }

      @media (max-width: 480px) {
        .login-container {
          padding: 30px 20px;
        }

        .logo h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Form -->
    <div class="login-container">
      <div class="logo">
        <h1>24HD</h1>
        <p>Always Ready â€¢ í•­ì‹œëŒ€ê¸°</p>
      </div>

      <div id="message-area"></div>

      <!-- Name + Password Login Form -->
      <form id="nameLoginForm">
        <div class="form-group">
          <label for="username">ì´ë¦„</label>
          <input
            type="text"
            id="username"
            class="form-input"
            placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
          <input
            type="password"
            id="password"
            class="form-input"
            placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            required
          />
        </div>

        <button type="submit" class="login-btn" id="nameLoginBtn">
          ë¡œê·¸ì¸
        </button>
      </form>

      <div class="divider">
        <span>ë˜ëŠ”</span>
      </div>

      <button class="social-btn google-btn" id="googleLoginBtn">
        <span>ğŸ“§</span>
        Googleë¡œ ë¡œê·¸ì¸
      </button>

      <button class="social-btn phone-btn" id="phoneLoginBtn">
        <span>ğŸ“±</span>
        ì „í™”ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸
      </button>

      <div class="loading" id="loading">ë¡œê·¸ì¸ ì¤‘...</div>

      <div class="register-link">
        <a href="#" onclick="openRegisterModal()"
          >ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</a
        >
      </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal" id="registerModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeRegisterModal()">
          &times;
        </button>

        <div class="logo">
          <h1>íšŒì›ê°€ì…</h1>
          <p>24HD íŒ€ì› ë“±ë¡</p>
        </div>

        <div id="register-message-area"></div>

        <form id="registerForm">
          <div class="form-group">
            <label for="regName">ì´ë¦„</label>
            <input
              type="text"
              id="regName"
              class="form-input"
              placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <div class="form-group">
            <label for="regEmail">ì´ë©”ì¼</label>
            <input
              type="email"
              id="regEmail"
              class="form-input"
              placeholder="example@gmail.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="regPhone">ì „í™”ë²ˆí˜¸</label>
            <input
              type="tel"
              id="regPhone"
              class="form-input"
              placeholder="ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (í•˜ì´í”ˆ ìë™ì¶”ê°€)"
              maxlength="13"
              required
            />
          </div>

          <div class="form-group">
            <label for="regPassword">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              type="password"
              id="regPassword"
              class="form-input"
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš” (6ì ì´ìƒ)"
              required
            />
          </div>

          <button type="submit" class="login-btn">íšŒì›ê°€ì…</button>
        </form>
      </div>
    </div>

    <!-- Phone Verification Modal -->
    <div class="modal" id="phoneModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closePhoneModal()">&times;</button>

        <div class="logo">
          <h1>ì „í™”ë²ˆí˜¸ ì¸ì¦</h1>
          <p>SMS ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div id="phone-message-area"></div>

        <div id="phone-input-section">
          <div class="form-group">
            <label for="phoneNumber">ì „í™”ë²ˆí˜¸</label>
            <input
              type="tel"
              id="phoneNumber"
              class="form-input"
              placeholder="010-1234-5678"
              required
            />
          </div>
          <button class="login-btn" onclick="sendPhoneVerification()">
            ì¸ì¦ë²ˆí˜¸ ì „ì†¡
          </button>
        </div>

        <div id="verification-section" style="display: none">
          <div class="form-group">
            <label for="verificationCode">ì¸ì¦ë²ˆí˜¸</label>
            <input
              type="text"
              id="verificationCode"
              class="form-input"
              placeholder="6ìë¦¬ ì¸ì¦ë²ˆí˜¸"
              required
            />
          </div>
          <button class="login-btn" onclick="verifyPhoneCode()">
            ì¸ì¦ ì™„ë£Œ
          </button>
        </div>

        <div id="recaptcha-container"></div>
      </div>
    </div>

    <script>
      // Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: "AIzaSyAL-tqJkto6vrWqEXIyeCRpraBwAXTmsks",
        authDomain: "hd-f6505.firebaseapp.com",
        projectId: "hd-f6505",
        storageBucket: "hd-f6505.firebasestorage.app",
        messagingSenderId: "359095818655",
        appId: "1:359095818655:web:82688d07a3ddd299c485aa",
        measurementId: "G-0DGRF1WE37",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // êµ¬ê¸€ì‹œíŠ¸ ì„¤ì •
      const SPREADSHEET_ID = "160nelH047treCnP5TG1GSpmQeHWv09s27-12guPdmC8";
      const API_KEY = "AIzaSyAikHrEbL6cMIM4CPoLA30EEiWHrOWIod4";
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwt6a8HBT7eanues0wQgAXE9-8nWH8Sl8htTBUzcpQCxuqdghPusQ-mN82otwFkH4gJyQ/exec";

      // ì „í™”ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ ì¶”ê°€ ê¸°ëŠ¥ (ê°œì„ )
      function formatPhoneNumber(input) {
        // ìˆ«ìë§Œ ì¶”ì¶œ
        let value = input.value.replace(/\D/g, "");

        // 11ìë¦¬ ì´ˆê³¼í•˜ë©´ ìë¥´ê¸°
        if (value.length > 11) {
          value = value.substring(0, 11);
        }

        // í•˜ì´í”ˆ ì¶”ê°€
        let formatted = "";
        if (value.length <= 3) {
          formatted = value;
        } else if (value.length <= 7) {
          formatted = value.substring(0, 3) + "-" + value.substring(3);
        } else {
          formatted =
            value.substring(0, 3) +
            "-" +
            value.substring(3, 7) +
            "-" +
            value.substring(7);
        }

        input.value = formatted;
      }

      // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ í¬ë§·íŒ… (ë‹¨ìˆœí™”)
      function setupPhoneFormatting() {
        const phoneInput = document.getElementById("regPhone");

        // input ì´ë²¤íŠ¸ë§Œ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€)
        phoneInput.addEventListener("input", function (e) {
          formatPhoneNumber(this);
        });
      }

      // í•œêµ­ ì‹œê°„ í¬ë§·
      function getKoreanDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}`;
      }

      // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMessage(message, type = "error", target = "message-area") {
        const messageArea = document.getElementById(target);
        const messageClass =
          type === "success" ? "success-message" : "error-message";
        messageArea.innerHTML = `<div class="${messageClass}">${message}</div>`;

        setTimeout(() => {
          messageArea.innerHTML = "";
        }, 5000);
      }

      // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ì´ë¦„ìœ¼ë¡œ ì´ë©”ì¼ ì°¾ê¸°
      async function getEmailByName(name) {
        try {
          console.log("ğŸ” ì´ë¦„ìœ¼ë¡œ ì´ë©”ì¼ ì°¾ëŠ” ì¤‘:", name);
          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/member%20data!A:F?key=${API_KEY}`
          );
          const data = await response.json();

          if (data.values) {
            const users = data.values.slice(1); // í—¤ë” ì œì™¸
            const user = users.find((row) => row[0] === name);

            if (user && user[2]) {
              // Cì—´: ì´ë©”ì¼
              console.log("ğŸ“§ ì°¾ì€ ì´ë©”ì¼:", user[2]);
              return user[2];
            }
          }
          console.log("âŒ í•´ë‹¹ ì´ë¦„ì˜ ì´ë©”ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");
          return null;
        } catch (error) {
          console.error("ì´ë©”ì¼ ì¡°íšŒ ì˜¤ë¥˜:", error);
          return null;
        }
      }

      // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ì •íšŒì› ëª©ë¡ ì½ê¸°
      async function getPremiumMembers() {
        try {
          const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/premium%20members!A:A?key=${API_KEY}`
          );
          const data = await response.json();
          if (data.values) {
            const members = data.values
              .flat()
              .filter((name) => name.trim() !== "");
            return members;
          }
          return [];
        } catch (error) {
          console.error("ì •íšŒì› ëª©ë¡ ì½ê¸° ì˜¤ë¥˜:", error);
          return [];
        }
      }

      // êµ¬ê¸€ì‹œíŠ¸ì— ì‚¬ìš©ì ì¶”ê°€ (ì •íšŒì› ìë™ íŒë³„)
      async function addUserToSheet(userData, passwordFromForm) {
        try {
          console.log("ğŸ“¤ êµ¬ê¸€ì‹œíŠ¸ì— ì‚¬ìš©ì ì¶”ê°€...");

          // ì •íšŒì› ì—¬ë¶€ ìë™ íŒë³„
          const isPremium = await checkPremiumStatus(userData.name);
          const premiumStatus = isPremium ? "O" : "X";

          console.log(
            "ğŸ‘‘ ì •íšŒì› ìë™ íŒë³„ ê²°ê³¼:",
            userData.name,
            "â†’",
            premiumStatus
          );

          const sheetData = {
            name: userData.name,
            phone: userData.phone,
            email: userData.email || "",
            premium: premiumStatus, // ìë™ íŒë³„ëœ O ë˜ëŠ” X
            password: passwordFromForm, // ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸
            registerTime: getKoreanDateTime(),
            uid: userData.uid || "",
          };

          console.log(
            "ğŸ“ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ë°ì´í„°:",
            JSON.stringify(sheetData, null, 2)
          );

          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userData: sheetData }),
          });

          console.log("âœ… êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì™„ë£Œ");
          return true;
        } catch (error) {
          console.error("êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
          return false;
        }
      }

      // ì •íšŒì› ì—¬ë¶€ í™•ì¸
      async function checkPremiumStatus(userName) {
        try {
          const premiumMembers = await getPremiumMembers();
          return premiumMembers.includes(userName);
        } catch (error) {
          console.error("ì •íšŒì› í™•ì¸ ì˜¤ë¥˜:", error);
          return false;
        }
      }

      // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
      async function handleLoginSuccess(userData) {
        const isPremium = await checkPremiumStatus(userData.name);

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
        const userInfo = {
          name: userData.name,
          phone: userData.phone,
          email: userData.email,
          isPremium: isPremium,
          loginTime: new Date().getTime(),
        };

        localStorage.setItem("24hd_user", JSON.stringify(userInfo));

        if (isPremium) {
            window.location.href = "../Main-Components/portal-loading.html"; 
        } else {
            window.location.href = "index.html"; 
        }
      }

      // Firebase ê¸°ë°˜ íšŒì›ê°€ì…
      async function handleFirebaseRegister(name, email, phone, password) {
        try {
          console.log("ğŸ”¥ Firebase íšŒì›ê°€ì… ì‹œì‘...");

          // Firebase ê³„ì • ìƒì„±
          const userCredential = await auth.createUserWithEmailAndPassword(
            email,
            password
          );
          const user = userCredential.user;

          console.log("âœ… Firebase ê³„ì • ìƒì„± ì„±ê³µ");

          // ì‚¬ìš©ì ë°ì´í„° êµ¬ì„±
          const userData = {
            name: name,
            phone: phone,
            email: email,
            uid: user.uid,
          };

          return userData;
        } catch (error) {
          console.error("Firebase íšŒì›ê°€ì… ì˜¤ë¥˜:", error);

          let errorMessage = "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          if (error.code === "auth/email-already-in-use") {
            errorMessage = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
          } else if (error.code === "auth/weak-password") {
            errorMessage =
              "ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ê°„ë‹¨í•©ë‹ˆë‹¤. (6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”)";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.";
          }

          throw new Error(errorMessage);
        }
      }

      // Firebase ê¸°ë°˜ ë¡œê·¸ì¸ (ì´ë¦„ìœ¼ë¡œ ì´ë©”ì¼ ì°¾ì•„ì„œ)
      async function handleFirebaseLogin(name, password) {
        try {
          console.log("ğŸ” Firebase ë¡œê·¸ì¸ ì‹œì‘...");

          // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ì´ë¦„ìœ¼ë¡œ ì´ë©”ì¼ ì°¾ê¸°
          const email = await getEmailByName(name);

          if (!email) {
            throw new Error(`"${name}" ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.`);
          }

          console.log("ğŸ“§ ì°¾ì€ ì´ë©”ì¼ë¡œ Firebase ë¡œê·¸ì¸ ì‹œë„");

          // Firebase ë¡œê·¸ì¸
          const userCredential = await auth.signInWithEmailAndPassword(
            email,
            password
          );
          const user = userCredential.user;

          console.log("âœ… Firebase ë¡œê·¸ì¸ ì„±ê³µ");

          const userData = {
            name: name,
            email: user.email,
            uid: user.uid,
            phone: "",
            isApproved: true,
          };

          return userData;
        } catch (error) {
          console.error("Firebase ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);

          let errorMessage = error.message;
          if (error.code === "auth/user-not-found") {
            errorMessage = `"${name}" ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.`;
          } else if (error.code === "auth/wrong-password") {
            errorMessage = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          } else if (error.code === "auth/too-many-requests") {
            errorMessage =
              "ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ ì‹œë„ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
          }

          throw new Error(errorMessage);
        }
      }

      // ì´ë¦„+ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì²˜ë¦¬
      async function handleNameLogin(event) {
        event.preventDefault();
        console.log("ğŸ” ì´ë¦„+ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œì‘!");

        const name = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const loginBtn = document.getElementById("nameLoginBtn");
        const loading = document.getElementById("loading");

        if (!name || !password) {
          showMessage("ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        loginBtn.disabled = true;
        loading.style.display = "block";

        try {
          // Firebaseë¡œ ë¡œê·¸ì¸ ì‹œë„
          const userData = await handleFirebaseLogin(name, password);
          await handleLoginSuccess(userData);
        } catch (error) {
          console.log("ë¡œê·¸ì¸ ì—ëŸ¬:", error.message);
          showMessage(error.message);
        } finally {
          loginBtn.disabled = false;
          loading.style.display = "none";
        }
      }

      // íšŒì›ê°€ì… ì²˜ë¦¬ (ì •íšŒì› ìë™ íŒë³„)
      async function handleRegister(event) {
        event.preventDefault();
        console.log("ğŸ”¥ íšŒì›ê°€ì… ì‹œì‘!");

        const name = document.getElementById("regName").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const phone = document.getElementById("regPhone").value.trim();
        const password = document.getElementById("regPassword").value;

        console.log(
          "ğŸ“ ì…ë ¥ê°’:",
          JSON.stringify({ name, email, phone, password: "***" }, null, 2)
        );

        if (!name || !email || !phone || !password) {
          showMessage(
            "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
            "error",
            "register-message-area"
          );
          return;
        }

        // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage(
            "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
            "error",
            "register-message-area"
          );
          return;
        }

        // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (í•˜ì´í”ˆ ì œê±°í•˜ê³  ì²´í¬)
        const phoneNumbers = phone.replace(/\D/g, ""); // ìˆ«ìë§Œ ì¶”ì¶œ
        if (phoneNumbers.length !== 11 || !phoneNumbers.startsWith("010")) {
          showMessage(
            "ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (xxxìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬)",
            "error",
            "register-message-area"
          );
          return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì¦
        if (password.length < 6) {
          showMessage(
            "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",
            "error",
            "register-message-area"
          );
          return;
        }

        try {
          // ì´ë¦„ ì¤‘ë³µ í™•ì¸
          const existingEmail = await getEmailByName(name);
          if (existingEmail) {
            showMessage(
              `"${name}" ì´ë¦„ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`,
              "error",
              "register-message-area"
            );
            return;
          }

          // Firebase íšŒì›ê°€ì…
          const userData = await handleFirebaseRegister(
            name,
            email,
            phone,
            password
          );

          // êµ¬ê¸€ì‹œíŠ¸ì— ì €ì¥ (ì •íšŒì› ìë™ íŒë³„ + ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
          const sheetSuccess = await addUserToSheet(userData, password);

          // ì •íšŒì› ì—¬ë¶€ í™•ì¸í•´ì„œ ë©”ì‹œì§€ í‘œì‹œ
          const isPremium = await checkPremiumStatus(name);
          const premiumText = isPremium ? "ì •íšŒì›" : "ì¼ë°˜íšŒì›";

          alert(
            `${name}ë‹˜, ${premiumText}ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\nì´ì œ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            "success",
            "register-message-area"
          );

          document.getElementById("registerForm").reset();

          closeRegisterModal();
        } catch (error) {
          showMessage(error.message, "error", "register-message-area");
        }
      }

      // Google ë¡œê·¸ì¸
      async function handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        const loading = document.getElementById("loading");

        loading.style.display = "block";

        try {
          const result = await auth.signInWithPopup(provider);
          const user = result.user;

          const userData = {
            name: user.displayName,
            email: user.email,
            phone: "",
            uid: user.uid,
          };

          await handleLoginSuccess(userData);
        } catch (error) {
          showMessage(getFirebaseErrorMessage(error.code));
        } finally {
          loading.style.display = "none";
        }
      }

      // ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸ ëª¨ë‹¬
      function openPhoneModal() {
        document.getElementById("phoneModal").style.display = "block";

        if (!window.recaptchaVerifier) {
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
            "recaptcha-container",
            {
              size: "normal",
              callback: function (response) {
                console.log("reCAPTCHA ì™„ë£Œ");
              },
            }
          );
        }
      }

      function closePhoneModal() {
        document.getElementById("phoneModal").style.display = "none";
        document.getElementById("phone-message-area").innerHTML = "";
      }

      async function sendPhoneVerification() {
        const phoneNumber = document.getElementById("phoneNumber").value;

        if (!phoneNumber) {
          showMessage(
            "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
            "error",
            "phone-message-area"
          );
          return;
        }

        try {
          window.confirmationResult = await auth.signInWithPhoneNumber(
            phoneNumber,
            window.recaptchaVerifier
          );

          document.getElementById("phone-input-section").style.display = "none";
          document.getElementById("verification-section").style.display =
            "block";
          showMessage(
            "ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "success",
            "phone-message-area"
          );
        } catch (error) {
          showMessage(
            getFirebaseErrorMessage(error.code),
            "error",
            "phone-message-area"
          );
        }
      }

      async function verifyPhoneCode() {
        const code = document.getElementById("verificationCode").value;

        if (!code) {
          showMessage(
            "ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
            "error",
            "phone-message-area"
          );
          return;
        }

        try {
          const result = await window.confirmationResult.confirm(code);
          const user = result.user;

          closePhoneModal();

          const userData = {
            name: user.phoneNumber,
            phone: user.phoneNumber,
            email: "",
            uid: user.uid,
          };

          await handleLoginSuccess(userData);
        } catch (error) {
          showMessage(
            "ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
            "error",
            "phone-message-area"
          );
        }
      }

      // Firebase ì—ëŸ¬ ë©”ì‹œì§€
      function getFirebaseErrorMessage(errorCode) {
        const errorMessages = {
          "auth/popup-closed-by-user": "ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
          "auth/cancelled-popup-request": "ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
          "auth/too-many-requests":
            "ë„ˆë¬´ ë§ì€ ì‹œë„ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
          "auth/invalid-phone-number": "ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.",
          "auth/missing-phone-number": "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.",
          "auth/quota-exceeded": "SMS í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.",
          "auth/invalid-verification-code": "ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
          "auth/code-expired": "ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
        };

        return errorMessages[errorCode] || "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }

      // ëª¨ë‹¬ ê´€ë¦¬
      function openRegisterModal() {
        document.getElementById("registerModal").style.display = "block";
      }

      function closeRegisterModal() {
        document.getElementById("registerModal").style.display = "none";
        document.getElementById("register-message-area").innerHTML = "";
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document
        .getElementById("nameLoginForm")
        .addEventListener("submit", handleNameLogin);
      document
        .getElementById("googleLoginBtn")
        .addEventListener("click", handleGoogleLogin);
      document
        .getElementById("phoneLoginBtn")
        .addEventListener("click", openPhoneModal);
      document
        .getElementById("registerForm")
        .addEventListener("submit", handleRegister);

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… ì„¤ì •
      document.addEventListener("DOMContentLoaded", function () {
        setupPhoneFormatting();
      });

      // ì¦‰ì‹œ ì‹¤í–‰ë„ ì¶”ê°€ (DOMContentLoaded ì´ë²¤íŠ¸ í›„ì— ë¡œë“œë˜ëŠ” ê²½ìš° ëŒ€ë¹„)
      setupPhoneFormatting();

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      window.onclick = function (event) {
        const phoneModal = document.getElementById("phoneModal");
        const registerModal = document.getElementById("registerModal");

        if (event.target === phoneModal) {
          closePhoneModal();
        }
        if (event.target === registerModal) {
          closeRegisterModal();
        }
      };

      console.log("ğŸš€ 24HD Firebase + êµ¬ê¸€ì‹œíŠ¸ í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!");
    </script>
  </body>
</html>
